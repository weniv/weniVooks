---
chapter: 3. SQL 7원칙
title: 6. SQL 6원칙 - Having 집계 자료 필터링 하기
date: 2024-05-10
---

# 수업목표

- Group by와 함께 Having 절을 사용하여 그룹화된 결과에 조건을 적용하는 방법을 배웁니다.
- Having 절에서 집계 함수를 활용하여 조건을 설정하는 방법을 익힙니다.
- Where 절과 Having 절의 차이점을 알아보고, 적절한 상황에 맞게 사용할 수 있습니다.
- 실습을 통해 Having 절을 활용한 데이터 필터링 능력을 기릅니다.

# 개요

이전 시간에는 Group by를 사용하여 데이터를 그룹화하고, 그룹화된 데이터에 대해 집계 함수를 적용하는 방법에 대해 학습했습니다. 그러나 때로는 그룹화된 결과에서 특정 조건을 만족하는 그룹만 추출해야 하는 경우가 있습니다. 이때 사용할 수 있는 것이 바로 Having 절입니다.

예를 들어, 상품 카테고리별로 총 매출액을 집계할 때, ~별이라고 그룹화해야 하니 group by를 사용하겠죠? 

1. 집계의 기준은?
카테고리별 → select와 group by 모두 ‘상품 카테고리’를 넣는다.
2. 결과값의 모습은?
총 매출액 → select 다음에 sum을 사용한다. 

```sql
SELECT 상품 카테고리, sum(주문금액)
FROM 주문
GROUP BY 상품 카테고리
```

만일 상품 카테고리별 총 매출액 중에서도, 일정 금액 이상인 값만 추출하려면 어떻게 할까요?

이 때 Having 절을 사용할 수 있습니다. 또한, 지역별 평균 구매 금액을 구한 후, 평균 구매 금액이 전체 평균보다 높은 지역만 선택하는 등의 분석도 가능합니다.

Having 절은 Group by 절 바로 뒤에 위치하며, 그룹화된 결과에 대해 조건을 설정할 때 사용됩니다. Having 절을 사용하면 집계 함수를 활용하여 조건을 지정할 수 있어, 보다 세부적인 데이터 필터링이 가능해집니다.

원하는 값을 필터링한다니, 이전에 배운 것중에 떠오르는 구문이 있지 않나요? 바로 where입니다. 

Having 절은 Where 절과 유사한 역할을 하지만, 사용 목적과 위치가 다릅니다. Where 절은 그룹화하기 전에 개별 행에 대한 조건을 설정하는 반면, Having 절은 그룹화된 결과에 대한 조건을 설정합니다. Where 절과 Having 절을 적절히 사용하여 원하는 데이터를 효과적으로 필터링할 수 있습니다.

이번 파트에서는 Having 절의 개념과 사용 방법에 대해 자세히 다루고, 실습을 통해 Having 절을 활용한 데이터 필터링 기술을 익혀보겠습니다. 이를 통해 데이터 분석 시 그룹화된 결과에서 원하는 조건에 맞는 데이터를 추출하는 능력을 갖출 수 있을 것입니다.

# 집계데이터에서 필요한 정보만 가져오는 - Having

Having 절의 기본 구문은 다음과 같습니다.

```sql
SELECT 열1, 열2, ..., 집계함수(열)
FROM 테이블명
GROUP BY 열1, 열2, ...
HAVING 조건식;
```

Having 절은 Group by 절 뒤에 위치하며, 조건식에는 집계 함수를 사용할 수 있습니다. 조건식이 참인 그룹만 결과에 포함됩니다.

# Having 실습

지난번의 Group by 실습자료를 그대로 가져와서 Having을 적용해보겠습니다.

<aside>
💡 업무 1 : 월별 평균 총주문금액을 구하고, 100만원 이하만 남겨줘

</aside>

<aside>
💡 업무 2 : 고객별 총주문금액 개수, 합, 평균을 구해줘, 건수가 1건은 제외해줘

</aside>

# 1) 100만원 이하만 남겨보자

## 1.1 예상업무지침 부여

첫번째 업무는 다음과 같았습니다.

<aside>
💡 업무 1 : 월별 평균 총주문금액을 구하고, 평균 총주문금액이 100만원 이하인 주문월만 남겨줘

</aside>

## 1.2 머릿속으로 미리 결과를 예상해보기

전체중에 100만원이 넘는 11월이 제외된 나머지만 남아야겠죠?

| 주문연도 | 주문월 | 총주문금액_평균 |
| --- | --- | --- |
| 2023 | 12 | 126400 |
| 2024 | 01 | 246720 |
| 2024 | 02 | 126540 |

## 1.3 그림을 보고 어떻게 할지 정리하기

기존 Group by 구문에서 having을 통해 100만원 이하인 값만 남아야 합니다.

![[SQL]6원칙_Having_1.6.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/8f069ec2-628d-4c1c-91a5-b7ea9650db8f/SQL6%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%8E%E1%85%B5%E1%86%A8_Having_1.6.png)

## 1.4 코드로 구현해보기

Having은 Group by가 무조건 필요하기 때문에 Group by구문을 먼저 준비합니다. 그 다음 Having을 통해 그룹화 된 테이블에서의 추가 가공을 진행합니다.

1. Group by 구문 필요

```sql
select 주문연도, 주문월, avg(총주문금액) as 총주문금액_평균 from 주문
group by 주문연도, 주문월
```

1. Having 조건 구하기

```sql
select 주문연도, 주문월, avg(총주문금액) as 총주문금액_평균 
from 주문
group by 주문연도, 주문월
having 총주문금액_평균 < 1000000
```

1. Where로 한번 해보기 - Where은 조건 전에 수행되기 때문에 되지 않습니다.

## 1.5 결과 확인하기

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/1393757e-318e-4907-869e-78c24e2e6247/Untitled.png)

# 2) 건수 1건은 제외하자

## 2.1 예상업무지침 부여

두번째 업무는 다음과 같습니다. 

<aside>
💡 업무 2 : 고객별 총주문금액 개수, 합, 평균을 구해줘, 건수가 1건은 제외해줘

</aside>

## 2.2 머릿속으로 미리 결과를 예상해보기

우리가 원하는 대로 배송주소별, 연도별 집계를 위에서 배운대로 수행하지만 제대로 결과가 나오지 않음을 볼 수가 있습니다. 

| 배송주소 | 주문연도 | count(*) |
| --- | --- | --- |
| 강원도 강릉시 강릉행복로 2828 | 2024 | 1 |
| 강원도 강릉시 동해대로 707 | 2023 | 1 |
| … | … | … |
| 충청남도 아산시 배반로 909 | 2024 | 1 |

그 이유는 배송주소는 아직 그룹화가 되기에는 너무나 많은 정보가 있기 때문입니다. 이를 우리가 원하는 집계를 할 수 있도록 배송주소를 시도별로 필요한 문자열만 추출해야합니다. 

| 시도 | 주문연도 | count(*) |
| --- | --- | --- |
| 강원 | 2024 | 2 |
| 경기 | 2024 | 2 |
| 경상 | 2024 | 3 |
| 세종 | 2024 | 3 |
| 제주 | 2024 | 4 |

## 2.3 그림을 보고 어떻게 할지 정리하기

![[SQL]6원칙_Having_2.4.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/83ef5ba6-5317-4cf8-ac3e-19f0fa509cfe/SQL6%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%8E%E1%85%B5%E1%86%A8_Having_2.4.png)

## 2.4 코드로 구현해보기

```sql
Select substr(배송주소,1,2) as 시도, 주문연도, count(*) as 연도_시도별_갯수
from 주문
Group by 시도, 주문연도 
having 연도_시도별_갯수 <> 1
```

## 2.5 결과 확인하기

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/579fe283-28aa-489d-ae65-d683304becfc/191d7d18-c41f-420b-958e-22566fe5e0f2/Untitled.png)

# Summary

Having을 통해 그룹화된 정보에서 추가적인 조건을 걸어서 원하는 정보만 추출하는 구문입니다. 즉 Group by가 없으면 나오지 않는 구문입니다. 언제나 Group by가 있으면 Having이 있는지 점검하시고 Where절과 헷갈리지 않으셨으면 좋겠습니다. 이상으로 Having을 마치겠습니다.