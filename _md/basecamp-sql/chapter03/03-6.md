---
chapter: SQL 7원칙
title: SQL 5원칙 - Group by 내가 원하는 집계 자료 만들기
date: 2024-05-10
---

# 수업목표

- Group by 구문을 활용해 데이터를 그룹화하는 방법을 배웁니다.
- 그룹화된 데이터에 대해 집계 함수를 적용하는 방법을 익힙니다.

# 개요

이전 수업에서는 `where`문을 활용해 원하는 데이터를 추출하는 방법에 대해 배웠습니다. 이번 수업에서는 데이터를 그룹화하여 분석하는 방법에 대해 알아보겠습니다.

데이터 분석 시 데이터를 특정 기준에 따라 그룹으로 나누어 살펴보면 더욱 의미 있는 인사이트를 도출할 수 있습니다. 예를 들어, 상품 카테고리별 총 매출액을 확인하거나 지역별 고객 수를 파악하는 등의 분석이 가능합니다.

이를 위해 SQL에서는 `group by` 구문을 제공합니다. `group by`를 사용하면 지정한 열을 기준으로 데이터를 그룹화할 수 있으며, 그룹화된 데이터에 대해 합계, 평균, 개수 등의 집계 함수를 적용할 수 있습니다.

이번 수업에서는 실습을 통해 `group by`의 기본 사용법을 익히고, 그리고 실무에서 자주 활용되는 예시까지 다뤄볼 예정입니다. SQL에서의 그룹화를 마스터하여 데이터 분석 능력을 한 단계 더 높여보시기 바랍니다.

# 1. 그룹 집계를 하는 Group by

:::div{.callout}

**업무 1 : 월별 총주문금액의 평균을 구해줘**

:::

:::div{.callout}

**업무 2 : 연도별, 지역별 주문 건수를 구해줘**

:::

그러면 2가지 업무에 대해서 수행해볼텐데요. 이를 통해 `group by`에 익숙해져보겠습니다.

보통 회사에서는 성과를 집계하거나 실적을 집계할때 월별 총주문금액, 연도별 주문건수처럼 00별 00으로 그룹화하여 집계합니다.

\*\*별(ex 성별, 연령별 등) 이라고 부르는 이 용어가 바로 그룹별 집계를 나타내는 것이고, 바로 `group by`를 사용하는 경우입니다.

| 순서 | 원하는 조건                                         | sql에서 할 일                                                       |
| ---- | --------------------------------------------------- | ------------------------------------------------------------------- |
| 1    | 집계의 기준을 정한다 - 성별 / 월별 / 지역별         | 1) group by에 기준이 되는 컬럼을 넣는다.                            |
|      |                                                     | 2) select에도 기준이 되는 컬럼을 똑같이 입력한다.                   |
| 2    | 결과값의 모습을 정한다 갯수 / 평균 / 최소 / 최대 등 | select 다음에 새로운 컬럼을 생성해서 집계 함수를 활용하여 계산한다. |

위의 준비를 업무 예시에 대입하여 이해해보겠습니다.

:::div{.callout}

**업무 1 : 월별 총주문금액의 평균을 구해줘**

:::

1. 집계의 기준은?
   월별 → select와 group by 모두 ‘주문월’을 넣는다.
2. 결과값의 모습은?
   총주문금액의 평균 → select 다음에 avg를 사용한다.

단계는 간단하지만 많은 분들이 `group by` 집계를 헷갈려 하시는데요. 1개의 기준으로 집계하여 익숙해진 뒤에 2개의 기준을 실습함으로써 `group by`를 어느 상황에서도 사용할 수 있게 구현해봅시다.

# 1) 월별 평균 총주문금액을 구하기

`group by` 실습은 ‘주문’ 테이블로 진행하겠습니다.

## 1.1 예상업무지침 부여

:::div{.callout}

월별 **총 주문금액의 평균**을 구해줘

:::

## 1.2 머릿속으로 미리 결과를 예상해보기

일반적인 월별 집계는 다음과 같이 자료를 만들죠?

| 주문월 | 총주문금액\_평균 |
| ------ | ---------------- |
| 01     | 246720           |
| 02     | 126540           |
| 11     | 1697000          |
| 12     | 126400           |

좀더 정확하게 집계를 하려면 다음과 같이 주문연도를 넣으면 좋겠죠?

| 주문연도 | 주문월 | 총주문금액\_평균 |
| -------- | ------ | ---------------- |
| 2023     | 11     | 1697000          |
| 2023     | 12     | 126400           |
| 2024     | 01     | 246720           |
| 2024     | 02     | 126540           |

우리는 `select`구문을 배우면서 평균 값을 구하는 법을 배웠으므로, 이번 실습때 배운대로 활용합니다.

## 1.3 그림을 보고 어떻게 할지 정리하기

Step 1.1

![Untitled](/images/basecamp-sql/chatper03-6/Group_by_1.1.png)

Step 1.2

![Untitled](/images/basecamp-sql/chatper03-6/Group_by_1.2.png)

Step 1.3

![Untitled](/images/basecamp-sql/chatper03-6/Group_by_1.3.png)

Step 1.4

![Untitled](/images/basecamp-sql/chatper03-6/Group_by_1.4.png)

## 1.4 코드로 구현해보기

처음 group by를 사용하시는 분들을 위해 단계별로 입력해보겠습니다.

1. from 주문 테이블 가져오기

```sql
from 주문
```

2. 그룹에 대한 기준 정하기(Group by에 한번, Select에 한번)

```sql
Select 주문월
from 주문
Group by 주문월
```

3. 어떤 집계를 할지 정하기

이제 Group by 문이 완성되었습니다. 결과를 확인합니다.

```sql
select 주문월, avg(총주문금액) as 총주문금액_평균
from 주문
group by 주문월
```

1. group by에 기준이 되는 열의 순서(1부터 시작)을 넣어도, 작동을 하게 됩니다. 현재는 주문월이라는 기준이 되는 열이 1개만 있기 때문에 1만 사용할 수 있습니다.

```sql
select 주문월, avg(총주문금액) as 총주문금액_평균
from 주문
group by 1
```

4. 기준이 2개 이상인 경우 ,를 통해 select에 여러 열자료를 불러오는 것처럼 동일하게 불러오면 됩니다.

```sql
select 주문연도, 주문월, avg(총주문금액) as 총주문금액_평균 from 주문
group by 주문연도, 주문월
```

```sql
select 주문연도, 주문월, avg(총주문금액) as 총주문금액_평균 from 주문
group by 1,2
```

## 1.5 결과 확인하기

![Untitled](/images/basecamp-sql/chatper03-6/Untitled.png)

# 2) 연도별, 지역별 주문 건수를 구하기

Group by 실습은 먼저 ‘주문’테이블로 진행하겠습니다.

## 2.1 예상업무지침 부여

두번째 업무는 다음과 같습니다.

:::div{.callout}

업무 2 : 연도별, 지역별 주문 건수를 구해줘

:::

## 2.2 머릿속으로 미리 결과를 예상해보기

주문 건수를 구하는 것이니까 count를 사용하면 되겠죠?

```sql
select count(*) # 전체 주문건수 집계
```

우리가 원하는 대로 배송주소별, 연도별 집계를 위에서 배운대로 수행하지만 제대로 결과가 나오지 않음을 볼 수가 있습니다.

| 배송주소                      | 주문연도 | count(\*) |
| ----------------------------- | -------- | --------- |
| 강원도 강릉시 강릉행복로 2828 | 2024     | 1         |
| 강원도 강릉시 동해대로 707    | 2023     | 1         |
| …                             | …        | …         |
| 충청남도 아산시 배반로 909    | 2024     | 1         |

지역별로 그룹화하기 위해 필요한 열인 배송주소에는 아직 그룹화가 되기에는 너무나 많은 정보가 있기 때문입니다. 지역별로 그룹화 하는 데에는 시도(서울시, 강원도 등) 정보만 필요하고 그 다음의 상세 정보는 필요가 없겠죠? 배송주소에서 상세주소는 빼고, 시도별로 필요한 문자열만 추출해야합니다.

| 시도 | 주문연도 | count(\*) |
| ---- | -------- | --------- |
| 강원 | 2023     | 1         |
| 강원 | 2024     | 2         |
| 경기 | 2024     | 2         |
| …    | …        | …         |
| 제주 | 2024     | 4         |
| 충청 | 2024     | 1         |

다음과 같은 결과를 얻으려면 우리는 substr라는 문자열을 다루는 함수에 대해서 알아야하는데요.

substr은 문자열의 일부분을 추출하는 데 사용되는 SQL 함수입니다. substr 함수를 사용하면 문자열에서 원하는 부분만을 선택적으로 가져올 수 있습니다.

substr 함수의 기본 구문은 다음과 같습니다.

```sql
substr(문자열, 시작위치, 추출할길이)
```

- 문자열: 부분 문자열을 추출할 대상 문자열입니다.
- 시작위치: 추출을 시작할 위치를 나타내는 정수입니다. 1부터 시작하며, 양수인 경우 문자열의 왼쪽부터, 음수인 경우 문자열의 오른쪽부터 시작합니다.
- 추출할길이: 추출할 문자의 개수를 나타내는 정수입니다. 생략할 경우 시작위치부터 문자열의 끝까지 추출합니다.

예를 들어, 다음과 같이 substr 함수를 사용할 수 있습니다.

```sql
select substr('hello world', 1, 5);
-- 결과: 'hello'

select substr('hello world', 7);
-- 결과: 'world'

select substr('hello world', -5);
-- 결과: 'world'
```

위의 예시에서 볼 수 있듯이, substr 함수를 사용하여 문자열의 특정 부분을 추출할 수 있습니다. 이를 활용하면 날짜 정보에서 연도, 월, 일을 추출하거나, 고객 이름에서 성과 이름을 분리하는 등 다양한 데이터 가공이 가능합니다.

substr 함수는 데이터 전처리 및 분석 단계에서 유용하게 활용될 수 있으며, Group by와 함께 사용하면 그룹화 기준을 보다 세분화할 수 있습니다. 예를 들어, 주문일자에서 연도만 추출하여 연도별로 그룹화하고 매출액을 집계하는 등의 분석이 가능해집니다.

substr 함수를 적절히 활용하여 필요한 부분 문자열을 추출함으로써 데이터 분석의 유연성과 효율성을 높일 수 있습니다.

## 2.3 그림을 보고 어떻게 할지 정리하기

Step 2.1

![[SQL]5원칙_Group by_2.1.png](/images/basecamp-sql/chatper03-6/Group_by_2.1.png)

Step 2.2

![[SQL]5원칙_Group by_2.2.png](/images/basecamp-sql/chatper03-6/Group_by_2.2.png)

Step 2.3

![[SQL]5원칙_Group by_2.3.png](/images/basecamp-sql/chatper03-6/Group_by_2.3.png)

Tip

![[SQL]5원칙_Group by_Tip.png](/images/basecamp-sql/chatper03-6/Group_by_Tip.png)

## 2.4 코드로 구현해보기

처음 group by를 사용하시는 분들을 위해 단계별로 입력해보겠습니다.

1. substr 함수 사용하여 Group by

```sql
select substr(배송주소,1,2) as 시도, 주문연도, count(*) from 주문
group by substr(배송주소,1,2), 주문연도;
```

1. substr된 새로운 컬럼명을 가지고 Group by

```sql
select substr(배송주소,1,2) as 시도, 주문연도, count(*) from 주문
group by 시도, 주문연도;
```

Tip. 주문날짜에서 새로운 주문연도를 추출해서 집계하기

```sql
select substr(배송주소,1,2) as 시도, substr(주문연도,1,4) as 주문연도_new, count(*)  from 주문
group by 시도, 주문연도_new;
```

## 2.5 결과 확인하기

![결과확인하기](/images/basecamp-sql/chatper03-6/Untitled1.png)

# Summary

Group by는 실제 업무에서 가장 많은 분석을 수행하는 구문인만큼 잘 익혀놓으셔야하는데요. 기존에 피벗테이블을 잘 쓰시는 분들이나 표로 잘 정리하시는 분들은 익숙하시리라 생각하고, 그렇지 않더라도 실습을 통해 충분히 익숙해지시리라 생각합니다.

여러 테이블을 통해 실습을 하신다면 자유자제로 사용하시리라 생각합니다.
