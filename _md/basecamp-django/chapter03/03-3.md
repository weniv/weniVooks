---
chapter: Model과 DataBase
title: CRUD 구현과 미디어 파일 실습
date: 2024-07-30
---
# 1. 게시물 생성과 삭제
Django의 ORM(Object-Relational Mapping)을 사용하여 게시판의 기본 기능인 게시물 생성과 삭제를 구현해보겠습니다. 이는 CRUD(Create, Read, Update, Delete) 작업 중 Create와 Delete에 해당합니다. 먼저 blog 앱의 urls.py와 views.py 파일을 수정하여 게시물 생성과 삭제 기능을 추가해 봅시다.

## 1.1 blog 앱의 urls.py 수정
urls.py파일에 url패턴을 추가합니다. 
```python
# blog > urls.py
from django.urls import path
from . import views

urlpatterns = [
    path("", views.blog_list, name="blog_list"),
    path("<int:pk>/", views.blog_detail, name="blog_detail"),
    path("create/<str:title>/", views.blog_create, name="blog_create"),
    path("delete/<int:pk>/", views.blog_delete, name="blog_delete"),
]
```
이 코드에서 새로 추가된 URL 패턴을 자세히 살펴보면,
1. `path("create/<str:title>/", views.blog_create, name="blog_create")`
이 패턴은 게시물 생성을 위한 URL로, `<str:title>` 부분은 게시물의 제목을 URL에 직접 입력하여 전달받는 방식입니다.
예를 들어 `/blog/create/안녕하세요/`라고 입력하면 '안녕하세요'라는 제목의 게시물이 생성됩니다.
2. `path("delete/<int:pk>/", views.blog_delete, name="blog_delete")`
이 패턴은 게시물 삭제를 하는 URL입니다. 위의 생성 URL과는 조금 다르게, `<int:pk>` 부분에 삭제할 게시물의 번호를 URL에 직접 입력하여 전달받는 방식입니다.
만약 `/blog/delete/3/`이라고 입력하면 3번 게시물이 삭제되는 것입니다.

## 1.2 blog 앱의 views.py 수정
views.py 파일에 URL에 접속하면 실행될 view 함수들을 추가합니다.
```python
# blog > views.py
from django.shortcuts import render, redirect
from .models import Post

def blog_list(request):
    blogs = Post.objects.all()
    context = {"db": blogs}
    return render(request, "blog/blog_list.html", context)

def blog_detail(request, pk):
    blog = Post.objects.get(pk=pk)
    context = {"db": blog}
    return render(request, "blog/blog_detail.html", context)

def blog_create(request, title):
    contents = f"hello world {title}"
    q = Post.objects.create(title=title, contents=contents)
    q.save()
    return redirect("blog_list")

def blog_delete(request, pk):
    q = Post.objects.get(pk=pk)
    q.delete()
    return redirect("blog_list")
```
각 함수를 간단히 살펴봅시다.
- blog_create
```python
def blog_create(request, title):
    contents = f"hello world {title}"
    q = Post.objects.create(title=title, contents=contents)
    q.save()
    return redirect("blog_list")
```
`blog_create(request, title)` 함수는 '/blog/create/제목/' 형식의 URL에 접속하면 실행됩니다. 이 함수는 URL에서 받은 제목을 사용하여 새 게시물을 만듭니다. Django ORM의 `Post.objects.create()` 메서드로 새로운 Post 객체를 생성하고, `q.save()`로 이를 데이터베이스에 저장합니다. 작업이 완료되면 `redirect("blog_list")`를 통해 사용자를 게시물 목록 페이지로 이동됩니다.

- blog_delete
```python
def blog_delete(request, pk):
    q = Post.objects.get(pk=pk)
    q.delete()
    return redirect("blog_list")
```
`blog_delete(request, pk)` 함수는 '/blog/delete/숫자/' 형식의 URL에 접속하면 실행됩니다. 이 함수는 URL에서 받은 숫자(ID)를 사용하여 해당 게시물을 찾아 삭제합니다. Django ORM의 `Post.objects.get(pk=pk)`로 지정된 ID의 게시물을 데이터베이스에서 찾고, `q.delete()`로 그 게시물을 삭제합니다. 삭제 작업이 완료되면, 게시물 생성 때와 마찬가지로 `redirect("blog_list")`를 통해 사용자를 게시물 목록 페이지로 이동합니다.
## 1.3 서버 실행 및 작동 테스트
이제 서버를 실행하고 새로 추가한 기능들을 테스트해봅시다.
```bash
python manage.py runserver
```
1. 게시물 생성
   다음과 같은 URL을 브라우저에 입력해보세요.
   ```
   http://127.0.0.1:8000/blog/create/orm/
   http://127.0.0.1:8000/blog/create/Jeju/
   http://127.0.0.1:8000/blog/create/11/
   ```
   각 URL에 접속하면, 해당 제목을 가진 새로운 게시물이 생성되고 게시물 목록 페이지로 이동합니다.

2. 게시물 삭제
   생성된 게시물의 ID를 확인한 후, 다음과 같은 URL을 입력해보세요.
   ```
   http://127.0.0.1:8000/blog/delete/1/
   http://127.0.0.1:8000/blog/delete/2/
   ```
   각 URL에 접속하면, 해당 ID를 가진 게시물이 삭제되고 게시물 목록 페이지로 이동합니다.
---
# 2. 이미지 업로드 실습
블로그는 단순히 글만 있는 곳이 아닙니다. 여러분의 생각과 경험을 더욱 생생하게 전달하기 위해 이미지, 동영상 등 다양한 미디어 파일들이 함께 사용됩니다. Django는 이런 다양한 미디어 파일들을 쉽게 관리할 수 있게 도와줍니다. 파일을 업로드하고, 저장하고, 웹페이지에 표시하는 모든 과정을 Django가 체계적으로 관리해줍니다. 이 실습에서는 Django를 사용하여 블로그 게시물에 이미지를 추가하고 관리하는 방법을 배워보겠습니다. 우리가 만들 웹사이트를 더욱 풍성하고 재미있게 만들 수 있을 것입니다.

```bash
pip install pillow
```
이전 장에서 개발 환경을 설정할 때 Pillow를 이미 설치했습니다. 혹시 설치하지 않았거나 확실하지 않다면, 위 명령어를 실행하여 Pillow를 설치해주시면 됩니다.
## 2.1 models.py 수정
먼저, 우리의 블로그 게시물에 이미지를 추가할 수 있게 만들어 봅시다. models.py 파일을 수정합니다.
```python
# blog > models.py
from django.db import models

class Post(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    main_image = models.ImageField(upload_to='blog/', blank=True, null=True) 
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.title
```
여기서 `main_imgage`라는 이름의 새로운 이미지 필드를 추가했습니다. 이 필드가 바로 이미지를 저장할 수 있게 해주는 필드입니다.
`upload_to='blog/'`는 업로드된 이미지를 'blog/' 폴더에 저장하라고 Django에게 알려주는 것이고,
`blank=True`와 `null=True`는 이 필드가 필수가 아닌, 선택사항이라는 것입니다. 즉, 모든 게시물에 이미지가 반드시 있어야 하는 것은 아닙니다.

모델을 변경했으므로 데이터베이스에 이 변경사항을 적용해야 합니다. 아래 명령어를 입력해 변경사항을 적용합니다.
```bash
python manage.py makemigrations
python manage.py migrate
```
## 2.2 settings.py 수정
이제 Django가 이미지 파일을 어디에 저장하고, 어떻게 불러올지 지정해줘야합니다. settings.py 파일에 미디어 파일 설정을 추가합니다.
```python
#settings.py
STATIC_URL = "static/"
STATICFILES_DIRS = [BASE_DIR / "static"]

MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"
```
## 2.3 media 폴더 생성
프로젝트의 가장 상위 폴더에 static, media 폴더를 만들어주세요.
```
db/
├── blog/
├── templates/
├── static/
└── media/

```
이 폴더에는 웹사이트에서 업로드한 이미지가 저장됩니다.
## 2.4 서버 실행 및 작동 테스트
```bash
python manage.py runserver
```
```
http://127.0.0.1:8000/admin
```
지금까지 한 작업을 저장하고 서버를 실행해봅시다. 관리자 페이지에서 이미지를 포함한 게시물을 3개 만들어보세요. 이미지 업로드 기능이 제대로 작동하는지 확인해봅시다.

## 2.5 url.py 수정
이제 웹에서 업로드한 이미지를 볼 수 있게 해봅시다. 
Django의 설정과 static기능을 사용하기 위해 모듈들을 임포트 하고 프로젝트의 urls.py 파일에 URL 패턴을 추가합니다.

```python
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path("admin/", admin.site.urls),
    path("blog/", include("blog.urls")),
]

urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```
추가한 마지막 줄인 `urlpatterns += static(...)` 코드는 미디어 파일을 서빙하기 위한 URL 패턴을 추가합니다. 이 URL로 웹사이트에서 업로드된 파일에 접근할 수 있습니다.
`settings.MEDIA_URL`은 웹 브라우저에서 미디어 파일에 접근할 때 사용되는 URL 경로입니다. 예를 들어, 폴더가 `/media/`로 설정되어 있다면 `http://mysite.com/media/image.jpg`와 같은 주소로 이미지에 접근할 수 있습니다.       
`document_root=settings.MEDIA_ROOT`는 미디어 파일이 실제 컴퓨터에 저장된 폴더의 위치를 지정합니다. 여기서는 우리가 이전에 생성한 'media' 폴더를 말합니다.
정리하자면, 이 코드는 `settings.MEDIA_URL`에 요청이 들어오면, `settings.MEDIA_ROOT`폴더에서 파일을 찾아 웹에 보여주는 역할을

## 2.6 템플릿 수정
관리자 페이지에서 올린 파일을 템플릿상에서 볼 수 있도록 템플릿을 수정합니다.
- blog_detail.html
```html
<!-- templates > blog > blog_detail.html -->
 <h1>게시판</h1>
<form action="" method="get">
    <input name="q" type="search">
    <button type="submit">검색</button>
</form>
<ul>
    {% for blog_detail in db %}
    <li>
        <a href="{% url 'blog_detail' blog_detail.id %}">{{ blog_detail.title }}</a>
        <p>{{blog_detail.contents}}</p>
    </li>
    {% endfor %}
</ul>
```
## 2.7 서버 실행 및 작동 테스트
이제 서버를 실행해서 작동이 되는지 확인해봅시다.
```bash
python manage.py runserver
```
생성된 게시물의 상세 페이지에서 이미지가 표시되는 것을 확인할 수 있습니다.

:::div{.callout}
만약 이미지가 보이지 않는다면, 파일이 제대로 저장되었는지 확인해보세요.
`media/blog/` 폴더에 이미지 파일이 있어야 합니다.
같은 이름의 파일을 여러 번 업로드하면 Django는 자동으로 파일 이름에 난수를 추가하여 저장합니다.
:::

---

# 3. 검색 기능 구현

웹 애플리케이션에서 검색 기능은 사용자 경험을 크게 향상시키는 핵심적인 요소입니다. Django를 사용하여 효과적인 검색 기능을 구현하는 방법을 살펴보겠습니다. 이 기능을 통해 사용자들은 원하는 정보를 빠르고 쉽게 찾을 수 있게 됩니다.

## 3.1 views.py 수정

검색 기능을 구현하기 위해 `views.py` 파일을 수정해야 합니다. 아래의 코드는 검색 로직을 포함한 `blog_list` 뷰 함수입니다.

```python
#views.py
from django.shortcuts import render
from .models import Post
from django.db.models import Q

def blog_list(request):
    if request.GET.get("q"):
        q = request.GET.get("q")
        blogs = Post.objects.filter(
            Q(title__icontains=q) | Q(content__icontains=q)
        ).distinct()
    else:
        blogs = Post.objects.all()
    context = {
        "object_list": blogs,
    }
    return render(request, "blog/blog_list.html", context)
```
장고의 `Q` 객체와 `filter` 메서드를 활용해 사용자가 입력한 검색어를 `request.GET.get("q")`로 가져와서, `Q` 객체를 통해 제목과 내용에서 대소문자 구분 없이 검색합니다. `icontains`을 사용하여 부분 일치도 찾아내며, `distinct()`로 중복 결과를 제거합니다. 이 방식으로 사용자의 검색어와 관련된 게시물만을 정확하게 필터링하여 표시할 수 있으며, 검색어가 없을 때는 모든 게시물을 보여줍니다.

## 3.1.1 Q 객체

Django의 Q 객체는 조건이나 복잡한 조건부 검색을 구현할 때 사용하는 유용한 도구 입니다.
예를 들어서, 우리의 검색 기능에서는 아래 예시와 같이 Q 객체를 사용했습니다.

```python
Q(title__icontains=q) | Q(content__icontains=q)
```
`|` 연산자는 OR 조건을 나타냅니다.
이 코드는 `제목에 검색어가 포함되어 있거나 아니면(OR) 내용에 검색어가 포함되어 있는 조건`을 표현합니다.

## 3.2 템플릿에 검색 폼 추가
다음으로, 사용자가 검색어를 입력할 수 있는 폼을 템플릿에 추가합니다.
```html
<h1>게시판</h1>
<form action="" method="get">
    <input name="q" type="search">
    <button type="submit">검색</button>
</form>
<ul>
    {% for blog_detail in object_list %}
    <li>
        <a href="{% url 'blog_detail' blog_detail.id %}">{{ blog_detail.title }}</a>
        <p>{{blog_detail.content}}</p>
        {% if blog_detail.main_image %}
            <img src="{{ blog_detail.main_image.url }}" alt="" style="width: 100px;">
        {% endif %}
    </li>
    {% endfor %}
</ul>
```
위 코드를 적용하면, 우리의 웹 페이지에 검색 기능이 추가됩니다. 아래에 코드에 대한 자세한 설명이 있습니다.

```html
<form action="" method="get">
    <input name="q" type="search">
    <button type="submit">검색</button>
</form>
```
이 코드로 인해 페이지 상단에 검색창과 '검색' 버튼이 생성됩니다. 사용자가 검색창에 키워드를 입력하고 '검색' 버튼을 클릭하거나 Enter 키를 누르면 검색이 실행됩니다. 이 때, 입력된 검색어는 URL의 쿼리 매개변수로 서버에 전송됩니다. url에 `?q=검색어`가 추가된 것을 볼 수 있습니다.

```python
results = BlogPost.objects.filter(Q(title__icontains=q) | Q(content__icontains=q))
```
서버에서는 전송받은 검색어를 이용해 데이터베이스를 검색합니다. Q 객체를 사용한 우리의 검색 로직은 게시물의 제목과 내용 중 검색어가 포함된 게시물만을 필터링합니다.

```python
<ul>
    {% for blog_detail in object_list %}
    <li>
        <a href="{% url 'blog_detail' blog_detail.id %}">{{ blog_detail.title }}</a>
        <p>{{blog_detail.content}}</p>
        {% if blog_detail.main_image %}
            <img src="{{ blog_detail.main_image.url }}" alt="" style="width: 100px;">
        {% endif %}
    </li>
    {% endfor %}
</ul>
```
검색 결과에 해당하는 게시물만이 페이지에 표시됩니다. 만약 검색어에 해당하는 게시물이 없다면, 아무 게시물도 표시되지 않습니다.

# 4. 참고 사항
Q객체에 대해서 더 궁금한 사항이 있다면, 아래의 장고 공식 문서를 참고하세요.
::a[Django 공식 문서- Q 객체]{class='btn-link' href="https://docs.djangoproject.com/en/5.0/topics/db/queries/#complex-lookups-with-q-objects" target="\_blank"}