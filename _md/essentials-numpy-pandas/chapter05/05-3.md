---
chapter: Pandas 활용
title: 데이터 분석과 시각화 심화
date: 2024-07-25
---


# 데이터 분석 개요

MovieLens 20M 데이터셋을 활용하여 영화 평점 데이터의 다양한 특성을 조사하고, 고급 시각화 기법을 통해 실전에서 어떻게 활용할 수 있는지를 학습합니다. 또한, 데이터 분석 기술을 사용하여 데이터의 패턴과 동향을 명확하게 전달하기 위한 그래프를 시각화 합니다. MovieLens 데이터셋은 Kaggle에서 다운로드할 수 있으며, 분석 과정에서 사용되는 Python의 Pandas 라이브러리와 데이터셋에 대한 더 자세한 정보는 "4장: Pandas란?" 목차를 참고하시면 됩니다.

# 1. 데이터 준비 및 기본 분석

## **1.1 데이터 로딩 및 전처리**

데이터 로딩 및 전처리 단계에서는 먼저 'movies.csv', 'ratings.csv', 그리고 'tags.csv' 파일들을 pandas 라이브러리를 사용하여 DataFrame으로 불러옵니다. 그 다음, 영화 데이터를 전처리하는 작업을 수행합니다. 영화 제목에 포함된 연도 정보를 추출하여 별도의 열로 만들고, 동시에 영화 제목에서 연도 정보를 제거합니다. 또한, 각 영화의 장르 정보를 개별 항목으로 분리합니다. 마지막으로, 평점 데이터에 포함된 타임스탬프 정보를 보다 다루기 쉬운 datetime 형식으로 변환합니다. 이러한 전처리 과정을 통해 데이터를 후속 분석에 적합한 형태로 준비합니다.

```python
# 데이터 로딩
# 데이터 로딩 (샘플링)
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

movies = pd.read_csv("C:\\Users\\User\\Desktop\\kaggle\\movie.csv", nrows=5000)
ratings = pd.read_csv("C:\\Users\\User\\Desktop\\kaggle\\rating.csv", nrows=1000000)
tags = pd.read_csv("C:\\Users\\User\\Desktop\\kaggle\\tag.csv")

# 데이터 전처리
movies['year'] = pd.to_datetime(movies['title'].str.extract('(\(\d{4}\))')[0], format='(%Y)').dt.year
movies['genres'] = movies['genres'].fillna('').str.split('|')
ratings['timestamp'] = pd.to_datetime(ratings['timestamp'])  

```
# 2. 평점 분석 및 시각화

## 2.1 평점 분포

**평점 분포 시각화:** 평점의 분포를 히스토그램과 KDE 커브를 통해 시각화합니다.

```python
# 평점 분포 그래프 생성 및 저장
plt.figure(figsize=(10, 6))
sns.histplot(ratings['rating'], bins=10, kde=False, color='skyblue')
plt.title("Distribution of Movie Ratings")
plt.xlabel("Rating")
plt.ylabel("Number of Ratings")
plt.grid(True)
plt.show()

```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/rating_distribution.png 'rating_distribution')

## 2.2 장르별 평점 분포

**장르별 평점 분포 시각화:** 영화의 장르별로 평점의 분포를 바이올린 플롯으로 표현합니다.

```python
genre_ratings = ratings.merge(movies[['movieId', 'genres']], on='movieId')
genre_ratings = genre_ratings.explode('genres')

plt.figure(figsize=(15, 10))
sns.violinplot(x='genres', y='rating', data=genre_ratings)
plt.xticks(rotation=90)
plt.title('Distribution of Ratings by Genre')
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/genre_rating_distribution.png 'genre_rating_distribution')

# 3. 시계열 분석

## 3.1 시간에 따른 평점 추이

**시간에 따른 평균 평점 추이**: 월별로 평균 평점을 계산하고 시계열 그래프로 시각화합니다.

```python
monthly_ratings = ratings.set_index('timestamp').resample('M')['rating'].mean()

plt.figure(figsize=(12, 6))
monthly_ratings.plot()
plt.title('Average Rating Over Time')
plt.xlabel('Date')
plt.ylabel('Average Rating')
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/rating_over_time.png 'rating_over_time')

## 3.2 연도별 개봉 영화 수와 평균 평점

**연도별 개봉 영화 수와 평균 평점**: 연도별 개봉 영화 수와 평균 평점을 듀얼 축 그래프로 비교합니다.

```python
yearly_stats = movies.groupby('year').agg({'movieId': 'count', 'title': 'first'})
yearly_ratings = ratings.merge(movies[['movieId', 'year']], on='movieId').groupby('year')['rating'].mean()
yearly_stats['avg_rating'] = yearly_ratings

fig, ax1 = plt.subplots(figsize=(15, 8))

ax1.set_xlabel('Year')
ax1.set_ylabel('Number of Movies', color='tab:blue')
ax1.plot(yearly_stats.index, yearly_stats['movieId'], color='tab:blue')
ax1.tick_params(axis='y', labelcolor='tab:blue')

ax2 = ax1.twinx()
ax2.set_ylabel('Average Rating', color='tab:orange')
ax2.plot(yearly_stats.index, yearly_stats['avg_rating'], color='tab:orange')
ax2.tick_params(axis='y', labelcolor='tab:orange')

plt.title('Number of Movies Released and Average Rating by Year')
fig.tight_layout()
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/yearly_movies_and_ratings.png 'early_movies_and_ratings')

# 4. 장르 분석

## 4.1 장르 분포

**장르 분포**: 영화 장르의 빈도를 막대 그래프로 나타냅니다.

```python
genre_counts = movies.explode('genres')['genres'].value_counts()

plt.figure(figsize=(12, 6))
genre_counts.plot(kind='bar')
plt.title('Distribution of Movie Genres')
plt.xlabel('Genre')
plt.ylabel('Count')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/genre_distribution.png 'genre_distribution')

# 5. 사용자 행동 분석

## 5.1 사용자별 평점 수 분포

**사용자별 평점 수 분포**: 각 사용자가 남긴 평점 수의 분포를 히스토그램으로 표현합니다.

```python
user_rating_counts = ratings['userId'].value_counts()

plt.figure(figsize=(10, 6))
sns.histplot(user_rating_counts, bins=50, kde=True)
plt.title('Distribution of Ratings per User')
plt.xlabel('Number of Ratings')
plt.ylabel('Number of Users')
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/user_rating_distribution.png 'user_rating_distribution')

## 5.2 평점 히트맵: 요일 vs 시간대

- **평점 히트맵**: 요일과 시간대별 평균 평점을 히트맵으로 시각화하여, 특정 시간대의 평점 패턴을 분석합니다.

```python
ratings['day_of_week'] = ratings['timestamp'].dt.day_name()
ratings['hour'] = ratings['timestamp'].dt.hour

rating_pivot = ratings.pivot_table(values='rating', index='day_of_week',
                                   columns='hour', aggfunc='mean')

plt.figure(figsize=(15, 10))
sns.heatmap(rating_pivot, cmap='YlOrRd', annot=True, fmt='.2f')
plt.title('Average Rating Heatmap: Day of Week vs Hour')
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/rating_heatmap.png 'rating_heatmap')

# 6. 태그 분석

## 6.1 상위 태그

**상위 태그**: 가장 많이 사용된 태그 20개의 빈도를 막대 그래프로 표현합니다.

```python
tag_counts = tags['tag'].value_counts().head(20)

plt.figure(figsize=(12, 6))
tag_counts.plot(kind='bar')
plt.title('Top 20 Most Used Tags')
plt.xlabel('Tag')
plt.ylabel('Count')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/top_tags.png 'top_tags')

## 6.2 연도별 태그 워드클라우드

**연도별 태그 워드클라우드**: 특정연도의 영화 태그를 워드클라우드로 시각화하여, 해당 연도의 인기 있는 태그를 시각적으로 분석합니다.

```python
from ipywidgets import interactive
import ipywidgets as widgets

def plot_wordcloud(year):
    year_tags = tags.merge(movies[['movieId', 'year']], on='movieId')
    year_tags = year_tags[year_tags['year'] == year]
    text = ' '.join(year_tags['tag'])
    wordcloud = WordCloud(width=800, height=400, background_color='white').generate(text)

    plt.figure(figsize=(10, 5))
    plt.imshow(wordcloud, interpolation='bilinear')
    plt.axis('off')
    plt.title(f'Movie Tags Wordcloud for Year {year}')
    plt.show()

interactive_plot = interactive(plot_wordcloud, year=widgets.IntSlider(min=1900, max=2024, step=1, value=2000))
display(interactive_plot)
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/top_tags.png 'top_tags')

# 7. 시계열 예측 모델

간단한 A**RIMA 모델을 이용한 시계열 예측**: ARIMA 모델을 사용하여 미래의 평균 평점을 예측하고, 이를 시각화합니다.

```python
from statsmodels.tsa.arima.model import ARIMA

# 데이터 준비
data = monthly_ratings.dropna()

# ARIMA 모델 피팅
model = ARIMA(data, order=(1,1,1))
results = model.fit()

# 향후 12개월 예측
forecast = results.forecast(steps=12)ㅇ
# 결과 시각화
plt.figure(figsize=(12, 6))
data.plot(label='Observed')
forecast.plot(label='Forecast')
plt.title('ARIMA Forecast of Average Ratings')
plt.xlabel('Date')
plt.ylabel('Average Rating')
plt.legend()
plt.show()
```
![주피터노트북](/images/basecamp-numpy-pandas/chapter05/top_tags.png 'top_tags')
